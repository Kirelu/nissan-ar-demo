<!DOCTYPE html>
<html>
<head>
    <title>AR.js Nissan Model Demo</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- We import ARjs library -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
        // Continuous rotation component
        AFRAME.registerComponent('auto-rotate', {
            schema: {
                speed: { type: 'number', default: 45 }
            },
            tick: function (_time, delta) {
                const rotation = this.el.getAttribute('rotation');
                rotation.y += (delta / 1000) * this.data.speed;
                this.el.setAttribute('rotation', rotation);
            }
        });

        // Keep entity aligned with marker while visible, retain last pose when lost
        AFRAME.registerComponent('marker-follow', {
            schema: {
                markerId: { type: 'string' },
                anchorId: { type: 'string', default: '' }
            },
            init: function () {
                this.markerEl = document.getElementById(this.data.markerId);
                this.anchorEl = this.data.anchorId ? document.getElementById(this.data.anchorId) : null;
                this.markerVisible = false;
                this.tmpMatrix = new THREE.Matrix4();

                if (this.markerEl) {
                    this.markerEl.addEventListener('markerFound', () => {
                        this.markerVisible = true;
                        this.el.setAttribute('visible', true);
                    });
                    this.markerEl.addEventListener('markerLost', () => {
                        this.markerVisible = false;
                    });
                }
            },
            tick: function () {
                if (!this.markerVisible) {
                    return;
                }

                if (!this.markerEl) {
                    return;
                }

                const sourceObj = (this.anchorEl && this.anchorEl.object3D)
                    ? this.anchorEl.object3D
                    : this.markerEl.object3D;
                const followerObj = this.el.object3D;

                if (!sourceObj || !followerObj) {
                    return;
                }

                this.tmpMatrix.copy(sourceObj.matrixWorld);
                followerObj.position.setFromMatrixPosition(this.tmpMatrix);
                followerObj.quaternion.setFromRotationMatrix(this.tmpMatrix);
                followerObj.scale.setFromMatrixScale(this.tmpMatrix);
            }
        });

        // Log any model loading errors and enable shadows on model
        AFRAME.registerComponent('model-loaded', {
            init: function () {
                this.el.addEventListener('model-loaded', (e) => {
                    console.log('Model loaded successfully');
                    
                    // Hide loading indicator
                    var loadingIndicator = document.getElementById('loadingIndicator');
                    if (loadingIndicator) {
                        loadingIndicator.setAttribute('visible', 'false');
                    }
                    
                    // Enable shadows on the model
                    const obj = this.el.getObject3D('mesh');
                    if (obj) {
                        obj.traverse((node) => {
                            if (node.isMesh) {
                                node.castShadow = true;
                                node.receiveShadow = true;
                            }
                        });
                    }
                });
                
                this.el.addEventListener('model-error', (error) => {
                    console.error('Error loading model:', error);
                });
            }
        });
        
        // Shadow plane component
        AFRAME.registerComponent('shadow-plane', {
            init: function() {
                // Create a transparent material for the shadow receiver
                const material = new THREE.ShadowMaterial();
                material.opacity = 0.3;
                
                // Apply it to the entity
                const mesh = this.el.getObject3D('mesh');
                if (mesh) {
                    mesh.material = material;
                    mesh.receiveShadow = true;
                }
            }
        });
        
        // Handle asset loading events
        document.addEventListener('DOMContentLoaded', function() {
            var scene = document.querySelector('a-scene');
            if (scene) {
                scene.addEventListener('loaded', function() {
                    console.log('Scene loaded');
                });
            }
            
            var model = document.querySelector('#nissan-model');
            if (model) {
                model.addEventListener('loaded', function() {
                    console.log('Nissan model asset loaded');
                });
                model.addEventListener('error', function(e) {
                    console.error('Error loading Nissan model asset:', e);
                });
            }
            
            // Hide loading indicator after 10 seconds regardless
            setTimeout(function() {
                var loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.setAttribute('visible', 'false');
                }
            }, 10000);
        });
    </script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene embedded vr-mode-ui="enabled: false" arjs="debugUIEnabled: false; sourceType: webcam; trackingMethod: best;"
             renderer="antialias: true; physicallyCorrectLights: true; shadowMapEnabled: true;">
        <!-- Preload assets -->
        <a-assets>
            <a-asset-item id="nissan-model" src="./nissan_skyline_r34_gtr_2002__www.vecarz.com/scene.gltf" crossorigin="anonymous" response-type="arraybuffer"></a-asset-item>
        </a-assets>
        
        <!-- Loading indicator -->
        <a-entity id="loadingIndicator" position="0 0 -2">
            <a-text value="Loading model..." align="center" color="white" position="0 0 0.1"></a-text>
            <!-- Background for text -->
            <a-plane color="black" width="3" height="0.5" position="0 0 0"></a-plane>
        </a-entity>

        <!-- Informational text -->
        <a-entity position="0 -1 -2">
            <a-text value="Cube rotates automatically" align="center" color="white" position="0 0 0.1" width="6"></a-text>
            <a-plane color="black" width="5" height="0.6" position="0 0 0"></a-plane>
        </a-entity>

        <!-- Marker anchor -->
        <a-marker id="hiroMarker" preset="hiro">
            <a-entity id="markerAnchor"></a-entity>
        </a-marker>

        <!-- Follower content -->
        <a-entity id="markerContent" visible="false"
                  marker-follow="markerId: hiroMarker; anchorId: markerAnchor">
            <!-- Directional light for shadows -->
            <a-light type="directional" position="1 2 1" intensity="0.6" castShadow="true" shadow="mapSize: 1024x1024; far: 10;"></a-light>
            
            <!-- Ambient light to prevent complete darkness -->
            <a-light type="ambient" intensity="0.3"></a-light>
            
            <!-- Shadow receiving ground plane -->
            <a-plane position="0 0 0" rotation="-90 0 0" width="3" height="3" shadow-plane></a-plane>
            
            <!-- Continuously rotating cube -->
            <a-box position="0 0.5 0" color="red" auto-rotate="speed: 30" shadow="cast: true; receive: true"></a-box>

            <!-- 3D model with visual placeholder while loading -->
            <a-entity 
                position="0 1 0"
                scale="0.001 0.001 0.001"
                rotation="-90 0 0"
                gltf-model="#nissan-model"
                model-loaded
                shadow="cast: true; receive: true">
                <!-- Placeholder while model loads -->
                <a-box position="0 0 0" color="#777777" width="1" height="0.1" depth="1" visible="true"></a-box>
            </a-entity>
        </a-entity>

        <a-entity camera></a-entity>
    </a-scene>
</body>
</html>