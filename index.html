<!DOCTYPE html>
<html>
<head>
    <title>AR.js Nissan Model Demo</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- We import ARjs library -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
        // Touch rotation component for interactive objects
        AFRAME.registerComponent('touch-rotate', {
            init: function () {
                this.isDragging = false;
                this.lastX = 0;
                this.lastY = 0;
                this.rotationSpeed = 0.5;
                this.originalColor = this.el.getAttribute('color') || 'red';

                // Touch start event
                this.el.addEventListener('touchstart', (e) => {
                    this.isDragging = true;
                    this.lastX = e.touches[0].clientX;
                    this.lastY = e.touches[0].clientY;

                    // Visual feedback - change color when touched
                    this.el.setAttribute('color', '#ff4444');
                    
                    // Prevent default to avoid scrolling
                    e.preventDefault();
                });

                // Touch move event
                this.el.addEventListener('touchmove', (e) => {
                    if (!this.isDragging) return;

                    e.preventDefault();

                    const currentX = e.touches[0].clientX;
                    const currentY = e.touches[0].clientY;

                    const deltaX = currentX - this.lastX;
                    const deltaY = currentY - this.lastY;

                    // Get current rotation
                    const currentRotation = this.el.getAttribute('rotation');
                    
                    // Rotate based on horizontal movement (Y-axis rotation)
                    const rotationY = currentRotation.y + (deltaX * this.rotationSpeed);

                    // Rotate based on vertical movement (X-axis rotation)
                    const rotationX = currentRotation.x - (deltaY * this.rotationSpeed);

                    this.el.setAttribute('rotation', {
                        x: rotationX,
                        y: rotationY,
                        z: currentRotation.z
                    });

                    this.lastX = currentX;
                    this.lastY = currentY;
                });

                // Touch end event
                this.el.addEventListener('touchend', () => {
                    this.isDragging = false;
                    // Reset color when touch ends
                    this.el.setAttribute('color', this.originalColor);
                });
                
                // Mouse events for desktop testing
                this.el.addEventListener('mousedown', (e) => {
                    this.isDragging = true;
                    this.lastX = e.clientX;
                    this.lastY = e.clientY;
                    this.el.setAttribute('color', '#ff4444');
                    e.preventDefault();
                });

                this.el.addEventListener('mousemove', (e) => {
                    if (!this.isDragging) return;

                    e.preventDefault();

                    const currentX = e.clientX;
                    const currentY = e.clientY;

                    const deltaX = currentX - this.lastX;
                    const deltaY = currentY - this.lastY;

                    // Get current rotation
                    const currentRotation = this.el.getAttribute('rotation');
                    
                    // Rotate based on horizontal movement (Y-axis rotation)
                    const rotationY = currentRotation.y + (deltaX * this.rotationSpeed);

                    // Rotate based on vertical movement (X-axis rotation)
                    const rotationX = currentRotation.x - (deltaY * this.rotationSpeed);

                    this.el.setAttribute('rotation', {
                        x: rotationX,
                        y: rotationY,
                        z: currentRotation.z
                    });

                    this.lastX = currentX;
                    this.lastY = currentY;
                });

                this.el.addEventListener('mouseup', () => {
                    this.isDragging = false;
                    this.el.setAttribute('color', this.originalColor);
                });

                this.el.addEventListener('mouseleave', () => {
                    this.isDragging = false;
                    this.el.setAttribute('color', this.originalColor);
                });
            }
        });

        // Log any model loading errors
        AFRAME.registerComponent('model-loaded', {
            init: function () {
                this.el.addEventListener('model-loaded', () => {
                    console.log('Model loaded successfully');
                    // Hide loading indicator
                    var loadingIndicator = document.getElementById('loadingIndicator');
                    if (loadingIndicator) {
                        loadingIndicator.setAttribute('visible', 'false');
                    }
                });
                this.el.addEventListener('model-error', (error) => {
                    console.error('Error loading model:', error);
                });
            }
        });
        
        // Handle asset loading events
        document.addEventListener('DOMContentLoaded', function() {
            var scene = document.querySelector('a-scene');
            if (scene) {
                scene.addEventListener('loaded', function() {
                    console.log('Scene loaded');
                });
            }
            
            var model = document.querySelector('#nissan-model');
            if (model) {
                model.addEventListener('loaded', function() {
                    console.log('Nissan model asset loaded');
                });
                model.addEventListener('error', function(e) {
                    console.error('Error loading Nissan model asset:', e);
                });
            }
            
            // Hide loading indicator after 10 seconds regardless
            setTimeout(function() {
                var loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.setAttribute('visible', 'false');
                }
            }, 10000);

            // Hide instructions after 5 seconds
            setTimeout(function() {
                var instructions = document.querySelector('[position="0 -1 -2"]');
                if (instructions) {
                    instructions.setAttribute('visible', 'false');
                }
            }, 5000);
        });
    </script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene embedded vr-mode-ui="enabled: false" arjs="debugUIEnabled: false; sourceType: webcam; trackingMethod: best;">
        <!-- Preload assets -->
        <a-assets>
            <a-asset-item id="nissan-model" src="./nissan_skyline_r34_gtr_2002__www.vecarz.com/scene.gltf" crossorigin="anonymous" response-type="arraybuffer"></a-asset-item>
        </a-assets>
        
        <!-- Loading indicator -->
        <a-entity id="loadingIndicator" position="0 0 -2">
            <a-text value="Loading model..." align="center" color="white" position="0 0 0.1"></a-text>
            <!-- Background for text -->
            <a-plane color="black" width="3" height="0.5" position="0 0 0"></a-plane>
        </a-entity>

        <!-- Touch instructions -->
        <a-entity position="0 -1 -2">
            <a-text value="Touch and drag the red cube to rotate!" align="center" color="white" position="0 0 0.1" width="6"></a-text>
            <a-plane color="black" width="7" height="0.8" position="0 0 0"></a-plane>
        </a-entity>
        <!-- Use a basic marker -->
        <a-marker preset="hiro">
            <!-- Simple box to verify marker detection -->
            <a-box position="0 0.5 0" color="red" touch-rotate></a-box>
            <!-- 3D model with visual placeholder while loading -->
            <a-entity 
                position="0 1 0"
                scale="0.001 0.001 0.001"
                rotation="-90 0 0"
                gltf-model="#nissan-model"
                model-loaded>
                <!-- Placeholder while model loads -->
                <a-box position="0 0 0" color="#777777" width="1" height="0.1" depth="1" visible="true"></a-box>
            </a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>
</body>
</html>