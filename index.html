<!DOCTYPE html>
<html>
<head>
    <title>AR.js Nissan Model Demo</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- We import ARjs library -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script>
        // Continuous rotation component
        AFRAME.registerComponent('auto-rotate', {
            schema: {
                speed: { type: 'number', default: 45 }
            },
            tick: function (_time, delta) {
                const rotation = this.el.getAttribute('rotation');
                rotation.z += (delta / 1000) * this.data.speed;
                this.el.setAttribute('rotation', rotation);
            }
        });

        // Keep entity aligned with marker while visible, retain last pose when lost
        AFRAME.registerComponent('marker-follow', {
            schema: {
                markerId: { type: 'string' },
                anchorId: { type: 'string', default: '' }
            },
            init: function () {
                this.markerEl = document.getElementById(this.data.markerId);
                this.anchorEl = this.data.anchorId ? document.getElementById(this.data.anchorId) : null;
                this.markerVisible = false;
                this.tmpMatrix = new THREE.Matrix4();

                if (this.markerEl) {
                    this.markerEl.addEventListener('markerFound', () => {
                        this.markerVisible = true;
                        this.el.setAttribute('visible', true);
                    });
                    this.markerEl.addEventListener('markerLost', () => {
                        this.markerVisible = false;
                    });
                }
            },
            tick: function () {
                if (!this.markerVisible) {
                    return;
                }

                if (!this.markerEl) {
                    return;
                }

                const sourceObj = (this.anchorEl && this.anchorEl.object3D)
                    ? this.anchorEl.object3D
                    : this.markerEl.object3D;
                const followerObj = this.el.object3D;

                if (!sourceObj || !followerObj) {
                    return;
                }

                this.tmpMatrix.copy(sourceObj.matrixWorld);
                followerObj.position.setFromMatrixPosition(this.tmpMatrix);
                followerObj.quaternion.setFromRotationMatrix(this.tmpMatrix);
                followerObj.scale.setFromMatrixScale(this.tmpMatrix);
            }
        });

        // Log any model loading errors and enable shadows on model
        AFRAME.registerComponent('model-loaded', {
            init: function () {
                this.el.addEventListener('model-loaded', (e) => {
                    console.log('Model loaded successfully');
                    
                    // Hide loading indicator
                    var loadingIndicator = document.getElementById('loadingIndicator');
                    if (loadingIndicator) {
                        loadingIndicator.setAttribute('visible', 'false');
                    }
                    
                    // Enable shadows on the model
                    const obj = this.el.getObject3D('mesh');
                    if (obj) {
                        obj.traverse((node) => {
                            if (node.isMesh) {
                                node.castShadow = true;
                                node.receiveShadow = true;
                            }
                        });
                    }
                });
                
                this.el.addEventListener('model-error', (error) => {
                    console.error('Error loading model:', error);
                });
            }
        });
        
        // Shadow plane component
        AFRAME.registerComponent('shadow-plane', {
            init: function() {
                // Create a transparent material for the shadow receiver
                const material = new THREE.ShadowMaterial();
                material.opacity = 0.3;
                
                // Apply it to the entity
                const mesh = this.el.getObject3D('mesh');
                if (mesh) {
                    mesh.material = material;
                    mesh.receiveShadow = true;
                }
            }
        });
        
        // Custom link handler for AR environment
        AFRAME.registerComponent('link-handler', {
            schema: {
                url: {type: 'string'},
                title: {type: 'string', default: 'Link'}
            },
            init: function() {
                var data = this.data;
                var el = this.el;
                
                // Add click event listener - triggered by fuse cursor
                el.addEventListener('click', function(evt) {
                    console.log('Link clicked: ' + data.title);
                    // Prevent event bubbling
                    evt.stopPropagation();
                    evt.preventDefault();
                    
                    // Navigate to the URL
                    setTimeout(function() {
                        window.location.href = data.url;
                    }, 300); // Small delay for better user experience
                });
            }
        });
        
        // Handle asset loading events
        document.addEventListener('DOMContentLoaded', function() {
            var scene = document.querySelector('a-scene');
            if (scene) {
                scene.addEventListener('loaded', function() {
                    console.log('Scene loaded');
                });
            }
            
            var model = document.querySelector('#nissan-model');
            if (model) {
                model.addEventListener('loaded', function() {
                    console.log('Nissan model asset loaded');
                });
                model.addEventListener('error', function(e) {
                    console.error('Error loading Nissan model asset:', e);
                });
            }
            
            // Hide loading indicator after 10 seconds regardless
            setTimeout(function() {
                var loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.setAttribute('visible', 'false');
                }
            }, 10000);
        });
    </script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene embedded vr-mode-ui="enabled: false" arjs="debugUIEnabled: false; sourceType: webcam; trackingMethod: best;"
             renderer="antialias: true; physicallyCorrectLights: true; shadowMapEnabled: true;">
        <!-- Preload assets -->
        <a-assets>
            <a-asset-item id="nissan-model" src="./nissan_skyline_r34_gtr_2002__www.vecarz.com/scene.gltf" crossorigin="anonymous" response-type="arraybuffer"></a-asset-item>
        </a-assets>
        
        <!-- Loading indicator -->
        <a-entity id="loadingIndicator" position="0 0 -2">
            <a-text value="Loading model..." align="center" color="white" position="0 0 0.1"></a-text>
            <!-- Background for text -->
            <a-plane color="black" width="3" height="0.5" position="0 0 0"></a-plane>
        </a-entity>

        <!-- Informational text -->
        <a-entity position="0 -1 -2">
            <a-text value="Cube rotates automatically" align="center" color="white" position="0 0 0.1" width="6"></a-text>
            <a-plane color="black" width="5" height="0.6" position="0 0 0"></a-plane>
        </a-entity>

        <!-- Marker anchor -->
        <a-marker id="hiroMarker" preset="hiro">
            <a-entity id="markerAnchor"></a-entity>
        </a-marker>

        <!-- Follower content -->
        <a-entity id="markerContent" visible="false"
                  marker-follow="markerId: hiroMarker; anchorId: markerAnchor">
            <!-- Directional light for shadows -->
            <a-light type="directional" position="1 2 1" intensity="0.8" castShadow="true" shadow="mapSize: 1024x1024; far: 10;"></a-light>
            
            <!-- Additional directional light from opposite side -->
            <a-light type="directional" position="-1 1 1" intensity="0.6" castShadow="false"></a-light>
            
            <!-- Ambient light to prevent complete darkness -->
            <a-light type="ambient" intensity="0.5"></a-light>
            
            <!-- Shadow receiving ground plane -->
            <a-plane position="0 0 0" rotation="-90 0 0" width="3" height="3" shadow-plane></a-plane>
            
            <!-- Continuously rotating cube -->
            <a-box position="0 0.5 0" color="red" auto-rotate="speed: 30" shadow="cast: true; receive: true"></a-box>

            <!-- 3D model with visual placeholder while loading -->
            <a-entity 
                position="0 1 0"
                scale="0.001 0.001 0.001"
                rotation="-90 0 0"
                gltf-model="#nissan-model"
                model-loaded
                shadow="cast: true; receive: true">
                <!-- Placeholder while model loads -->
                <a-box position="0 0 0" color="#777777" width="1" height="0.1" depth="1" visible="true"></a-box>
            </a-entity>
            
            <!-- 3D Information buttons -->
            <a-entity position="0 -0.05 0.5">
                <!-- English button - 3D box -->
                <a-entity position="-0.25 0.1 0" 
                          animation="property: position; to: -0.25 0.13 0; dir: alternate; dur: 1000; loop: true; easing: easeInOutQuad">
                    <a-box color="#1a73e8" width="0.3" height="0.1" depth="0.1" 
                           material="shader: standard; metalness: 0.5; roughness: 0.2"
                           link-handler="url: more-info-en.html; title: More Information"
                           class="clickable"
                           animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 300"
                           animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 300">
                        <a-text value="MORE" align="center" color="white" position="0 0 0.051" width="1.0" wrap-count="8"></a-text>
                    </a-box>
                </a-entity>
                
                <!-- Swedish button - 3D box -->
                <a-entity position="0.25 0.1 0"
                          animation="property: position; to: 0.25 0.13 0; dir: alternate; dur: 1000; loop: true; easing: easeInOutQuad; delay: 500">
                    <a-box color="#1a73e8" width="0.3" height="0.1" depth="0.1" 
                           material="shader: standard; metalness: 0.5; roughness: 0.2"
                           link-handler="url: mer-info-sv.html; title: Mer Information"
                           class="clickable"
                           animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 300"
                           animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 300">
                        <a-text value="MER" align="center" color="white" position="0 0 0.051" width="1.0" wrap-count="8"></a-text>
                    </a-box>
                </a-entity>
            </a-entity>
        </a-entity>

        <a-entity camera>
            <a-entity cursor="fuse: true; fuseTimeout: 1500"
                      position="0 0 -1"
                      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                      material="color: white; shader: flat; opacity: 0.5"
                      animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.1 0.1 0.1; to: 1 1 1"
                      animation__fusing="property: scale; startEvents: fusing; easing: easeInCubic; dur: 1500; from: 1 1 1; to: 0.5 0.5 0.5"
                      animation__mouseleave="property: scale; startEvents: mouseleave; easing: easeInCubic; dur: 500; to: 1 1 1"
                      animation__fusing_opacity="property: material.opacity; startEvents: fusing; easing: easeInCubic; dur: 300; from: 0.5; to: 1.0"
                      animation__mouseleave_opacity="property: material.opacity; startEvents: mouseleave; easing: easeInCubic; dur: 300; to: 0.5"
                      raycaster="objects: .clickable"></a-entity>
        </a-entity>
    </a-scene>
</body>
</html>